name: Playwright E2E Tests

on:
  push:
    branches: [main, develop]          # thay Ä‘á»•i theo nhu cáº§u
  pull_request:
    branches: [main]
  workflow_dispatch:                   # cho phÃ©p cháº¡y manual + nháº­p parameter
    inputs:
      playwright_tags:
        description: 'Playwright tags to run (vÃ­ dá»¥: @Read-json,@smoke)'
        required: false
        default: '@Read-json'
      workers:
        description: 'Number of workers'
        required: false
        default: '4'

permissions:
  contents: read

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # â”€â”€ Setup Node & cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'           # khá»›p vá»›i NodeJS_24.1.0 bÃªn báº¡n
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # â”€â”€ Clean previous reports (tÆ°Æ¡ng tá»± Clean Workspace) â”€â”€â”€â”€â”€â”€â”€
      - name: Clean previous reports
        run: |
          rm -rf playwright-report test-results allure-results allure-report || true

      # â”€â”€ Setup credentials.json â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup credentials.json
        env:
          CREDENTIALS_CONTENT: ${{ secrets.CREDENTIALS_JSON_CONTENT }}
        run: |
          mkdir -p data
          echo "$CREDENTIALS_CONTENT" > data/credentials.json
          chmod 600 data/credentials.json   # báº£o vá»‡ file

      # â”€â”€ Run Playwright Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Playwright tests
        env:
          PLAYWRIGHT_TAGS: ${{ inputs.playwright_tags || '@Read-json' }}
          WORKERS: ${{ inputs.workers || '4' }}
        run: |
          echo "Running tests with tags: $PLAYWRIGHT_TAGS"
          echo "Workers: $WORKERS"
          npx playwright test -g "$PLAYWRIGHT_TAGS" --workers=$WORKERS

      # â”€â”€ Post steps - Allure & Artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate Allure Report
        if: always()
        run: |
          npm install -g allure-commandline --save-dev || true
          npx allure generate allure-results --clean -o allure-report || true

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 14

      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 14

      # â”€â”€ Notify Google Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # - name: Notify Google Chat (Success)
      #   if: success()
      #   uses: google-github-actions/send-google-chat-webhook@v2
      #   with:
      #     url: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
      #     message: |
      #       **Build SUCCESSFULLY** ğŸ‰
      #       Branch: ${{ github.ref_name }}
      #       Commit: ${{ github.event.head_commit.message || github.event.pull_request.title }}
      #       Workflow: ${{ github.workflow }}
      #       Run: ${{ github.run_id }}
      #       Repository: ${{ github.repository }}
      #       URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      # - name: Notify Google Chat (Failure)
      #   if: failure()
      #   uses: google-github-actions/send-google-chat-webhook@v2
      #   with:
      #     url: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
      #     message: |
      #       **Build FAILED** âŒ
      #       Branch: ${{ github.ref_name }}
      #       Commit: ${{ github.event.head_commit.message || github.event.pull_request.title }}
      #       Workflow: ${{ github.workflow }}
      #       Run: ${{ github.run_id }}
      #       Repository: ${{ github.repository }}
      #       URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}